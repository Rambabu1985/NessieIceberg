# Performance testing Nessie with Gatling

## Setup

1. Follow the instructions in `perftest/measurement-pack/README.md` to start the "measurement-pack".
   "Measurement-Pack" is a Docker Compose setup that has all metrics+traces collection services
   as pre-configured Docker containers, Nessie server + Gatling tests run on the host to allow
   shorter turn-around times during development and debugging of both Nessie and the Gatling tests.
1. Build Nessie: go to the Nessie root directory and execute `./mvnw clean install`, activate the
   `-Pnative` profile, when testing a Graal native image.
1. Start the Nessie Server like you need it. In all cases you have to set these 
   environment variables:
    - `QUARKUS_JAEGER_ENDPOINT=http://127.0.0.1:14268/api/traces`
    - Without tracing: `QUARKUS_JAEGER_SAMPLER_TYPE=const` + `QUARKUS_JAEGER_SAMPLER_PARAM=0`
    - Everything traced: `QUARKUS_JAEGER_SAMPLER_TYPE=const` + `QUARKUS_JAEGER_SAMPLER_PARAM=1`
    - Probabilistic tracing: `QUARKUS_JAEGER_SAMPLER_TYPE=probabilistic` +
      `QUARKUS_JAEGER_SAMPLER_PARAM=0.01` (or any other value)
   Then run the Nessie server:
    - In your IDE in a Debugger...
    - From the command line as a Quarkus image (e.g. `java -jar servers/quarkus-server/target/quarkus-app/quarkus-run.jar`)
1. Run the Gatling test you'd like to run using the `gatling:test` in Maven for the
   `:nessie-perftest-gatling` project. See the "Full example" below for a list of parameters passed
   as system properties.

## `CommitToBranchSimulation`

| Parameter | Default value | Meaning
| --- | --- | ---
| sim.users | 1 |  number of users to simulate
| sim.commits | 100 | number of commits each simulated users adds
| sim.mode | BRANCH_PER_USER_SINGLE_TABLE | BRANCH_PER_USER_SINGLE_TABLE (default), BRANCH_PER_USER_RANDOM_TABLE, SINGLE_BRANCH_RANDOM_TABLE, SINGLE_BRANCH_TABLE_PER_USER, SINGLE_BRANCH_SINGLE_TABLE
| sim.branch | n/a | name of the branch to commit to (defaults to a name containing System.currentTimeMillis())
| sim.tablePrefix | n/a | prefix of the table name used in the commits (defaults to a name prefix containing System.currentTimeMillis())
| sim.prometheus | 127.0.0.1:9091 | hostname/IP + port of the Prometheus push gateway server
| sim.duration.seconds | 0 | maximum duration of the test in seconds (0 = not applied)
| sim.rate | 0 | rate of operations (0 = not applied / as fast as possible)
| sim.note | | arbitrary string that will be included in the prometheus metrics information
| http.maxConnections | 5 | set at least to the numebr of sim.users, otherwise HTTP requests will contend on the client side

## Full example

To use the local DynamoDB endpoint, add these environment variables when running the Nessie Server:
```shell
export NESSIE_VERSION_STORE_DYNAMO_INITIALIZE=true
export NESSIE_VERSION_STORE_TYPE=DYNAMO
export QUARKUS_DYNAMODB_ENDPOINT_OVERRIDE=http://127.0.0.1:8000
export QUARKUS_DYNAMODB_AWS_REGION=us-west-2
export AWS_ACCESS_KEY_ID=xxx
export AWS_SECRET_ACCESS_KEY=xxx
export QUARKUS_JAEGER_SAMPLER_TYPE=probabilistic
export QUARKUS_JAEGER_SAMPLER_PARAM=0.01
export QUARKUS_JAEGER_ENDPOINT=http://127.0.0.1:14268/api/traces
```

Example to run Nessie in a JVM:
```shell
java -Xms6g -Xmx6g -XX:+AlwaysPreTouch -jar servers/quarkus-server/target/quarkus-app/quarkus-run.jar
```

Example to run Nessie as a native image:
```shell
servers/quarkus-server/target/nessie-quarkus-*-SNAPSHOT-runner
```

To start the Gatling simulation w/ tracing:
```shell
export JAEGER_ENDPOINT=http://127.0.0.1:14268/api/traces
export JAEGER_SAMPLER_TYPE=probabilistic
export JAEGER_SAMPLER_PARAM=0.01
export JAEGER_SERVICE_NAME=nessie
./mvnw install gatling:test -Dgatling.simulationClass=org.projectnessie.perftest.gatling.CommitToBranchSimulation -pl :nessie-perftest-gatling
```

## Notes

Please note, that `Engine`, `IDEPathHelper` and `Recorder`in `src/test/scala` and
`src/test/resources/gatling.conf` are generated by the Maven archetype and technically not required
to run a simulation, but are required to actually debug a simulation, in which case you have to run
the `Engine` class.
