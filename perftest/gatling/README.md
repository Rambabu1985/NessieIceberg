# Performance testing Nessie with Gatling

## Setup

1. Follow the instructions in `perftest/measurement-pack/README.md` to start the measurement-pack
1. Build Nessie: go to the Nessie root directory and execute `./mvnw clean install`, activate the
   `-Pnative` profile, when testing a Graal native image.
1. Start the Nessie Server like you need it. In all cases you have to set these 
   environment variables:
    - `QUARKUS_JAEGER_ENDPOINT=http://127.0.0.1:14268/api/traces`
    - Without tracing: `QUARKUS_JAEGER_SAMPLER_TYPE=const` + `QUARKUS_JAEGER_SAMPLER_PARAM=0`
    - Everything traced: `QUARKUS_JAEGER_SAMPLER_TYPE=const` + `QUARKUS_JAEGER_SAMPLER_PARAM=1`
    - Probabilistic tracing: `QUARKUS_JAEGER_SAMPLER_TYPE=probabilistic` +
      `QUARKUS_JAEGER_SAMPLER_PARAM=0.01` (or any other value)
   Then run the Nessie server:
    - In your IDE in a Debugger...
    - From the command line as a Quarkus image (e.g. `java -jar servers/quarkus-server/target/quarkus-app/quarkus-run.jar`)
1. Run the Gatling test you'd like to run using the `gatling:test` in Maven for the
   `:nessie-perftest-gatling` project. See the "Full example" below for a list of parameters passed
   as system properties.

To use the local DynamoDB endpoint, add these environment variables when running the Nessie Server:
```
NESSIE_VERSION_STORE_DYNAMO_INITIALIZE=true
NESSIE_VERSION_STORE_TYPE=DYNAMO
QUARKUS_DYNAMODB_ENDPOINT_OVERRIDE=http://127.0.0.1:8000
QUARKUS_DYNAMODB_AWS_REGION=us-west-2
AWS_ACCESS_KEY_ID=xxx
AWS_SECRET_ACCESS_KEY=xxx
```

Example:
```
QUARKUS_LOG_FILE_ENABLE=true NESSIE_VERSION_STORE_DYNAMO_INITIALIZE=true NESSIE_VERSION_STORE_TYPE=DYNAMO QUARKUS_DYNAMODB_ENDPOINT_OVERRIDE=http://127.0.0.1:8000 QUARKUS_DYNAMODB_AWS_REGION=us-west-2 AWS_ACCESS_KEY_ID=xxx AWS_SECRET_ACCESS_KEY=xxx QUARKUS_JAEGER_SAMPLER_TYPE=probabilistic QUARKUS_JAEGER_SAMPLER_PARAM=0.01 QUARKUS_JAEGER_ENDPOINT=http://127.0.0.1:14268/api/traces java -Xms6g -Xmx6g -XX:+AlwaysPreTouch -jar servers/quarkus-server/target/quarkus-app/quarkus-run.jar
```

To start a Nessie native-image, replace the part above starting with the `java` executable with `servers/quarkus-server/target/nessie-quarkus-*-SNAPSHOT-runner`

To start the Gatling simulation w/ tracing:
```
JAEGER_ENDPOINT=http://127.0.0.1:14268/api/traces JAEGER_SAMPLER_TYPE=probabilistic JAEGER_SAMPLER_PARAM=0.01 JAEGER_SERVICE_NAME=nessie ./mvnw install gatling:test -Dgatling.simulationClass=org.projectnessie.perftest.gatling.CommitToBranchSimulation -Dsim.users=20 -Dhttp.maxConnections=100 -pl :nessie-perftest-gatling
```

## Full example

```shell

# Run the Gatling test  (parameter values represent the default values)
#   sim.users               -> number of users to simulate
#   sim.commits             -> number of commits each simulated users adds
#   sim.branch              -> name of the branch to commit to (defaults to a name containing System.currentTimeMillis())
#   sim.tablePrefix         -> prefix of the table name used in the commits (defaults to a name prefix containing System.currentTimeMillis())
#   sim.branchMode          -> BRANCH_PER_USER_SINGLE_TABLE (default), BRANCH_PER_USER_RANDOM_TABLE, SINGLE_BRANCH_RANDOM_TABLE, SINGLE_BRANCH_TABLE_PER_USER, SINGLE_BRANCH_SINGLE_TABLE
#   sim.prometheus          -> hostname/IP + port of the Prometheus push gateway server
#   sim.duration.seconds    -> maximum duration of the test in seconds (0 = not applied)
#   sim.rate                -> rate of operations (0 = not applied / as fast as possible)
#   sim.note                -> arbitrary string that will be included in the prometheus metrics information
#   http.maxConnections     -> set at least to the numebr of sim.users, otherwise HTTP requests will contend on the client side
./mvnw install gatling:test -Dgatling.simulationClass=org.projectnessie.perftest.gatling.CommitToBranchSimulation \
  -Dsim.users=1 \
  -Dsim.commits=100 \
  -Dsim.branchMode=BRANCH_PER_USER \
  -Dsim.prometheus=127.0.0.1:9091 \
  -Dsim.duration.seconds=0 \
  -Dsim.rate=0 \
  -Dhttp.maxConnections=5 \
  -pl :nessie-perftest-gatling
```

## Notes

Please note, that `Engine`, `IDEPathHelper` and `Recorder`in `src/test/scala` and
`src/test/resources/gatling.conf` are generated by the Maven archetype and technically not required
to run a simulation, but are required to actually debug a simulation, in which case you have to run
the `Engine` class.
