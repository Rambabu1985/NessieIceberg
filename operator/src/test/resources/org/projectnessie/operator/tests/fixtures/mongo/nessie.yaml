apiVersion: nessie.projectnessie.org/v1alpha1
kind: Nessie
metadata:
  name: nessie-test
spec:
  size: 1
  logLevel: DEBUG
  service:
    type: ClusterIP
    sessionAffinity: ClientIP
    port: 19120
    labels: {}
    annotations: {}
  versionStore:
    type: MongoDb
    cache:
      enabled: false
    mongoDb:
      connectionString: mongodb://nessie-mongodb.default.svc.cluster.local:27017/nessie
      database: nessie
      username: mongodb
      password:
        secret: nessie-db-credentials
        key: password
  ingress:
    enabled: true
    annotations:
      kubernetes.io/ingress.class: nginx
    rules:
      - host: nessie.example.com
        paths:
          - /
    tls:
      - secret: nessie-test-tls
        hosts:
          - nessie.example.com
  authentication:
    enabled: true
    oidcAuthServerUrl: http://keycloak:8080/auth/realms/nessie
    oidcClientId: quarkus-app
  authorization:
    enabled: true
    rules:
      allowViewingBranch: op=='VIEW_REFERENCE' && role.startsWith('test_user') && ref.startsWith('allowedBranch')
  telemetry:
    enabled: true
    endpoint: https://otlp-collector:4317
    sample: "0.5d"
    attributes:
      foo: "bar"
  monitoring:
    enabled: true
    labels:
      foo: bar
    interval: 1s
  autoscaling:
    enabled: true
    minReplicas: 1
    maxReplicas: 2
    targetCpuUtilizationPercentage: 80
    targetMemoryUtilizationPercentage: 80
  extraEnv:
    - name: QUARKUS_PROFILE
      value: "prod"
  advancedConfig:
    nessie.server.default-branch: my-branch
    nessie.version.store.persist.repository-id: my-repository
    quarkus:
      log:
        console.format: "%d{HH:mm:ss} %s%e%n"
        category."org.projectnessie".level: "TRACE"
  deployment:
    image:
      repository: projectnessie/nessie
      tag: 1.2.3
      pullPolicy: Never
    labels:
      foo: bar
    annotations:
      foo: bar
    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        cpu: 200m
        memory: 256Mi
    serviceAccount:
      create: true
      annotations:
        foo: bar
    podSecurityContext:
      fsGroup: 1000
    containerSecurityContext:
      runAsUser: 1000
      runAsGroup: 1000
    nodeSelector:
      foo: bar
    tolerations:
      - key: "key"
        operator: "Equal"
        value: "value"
        effect: "NoSchedule"
    affinity:
      nodeAffinity:
        requiredDuringSchedulingIgnoredDuringExecution:
          nodeSelectorTerms:
            - matchExpressions:
                - key: "key"
                  operator: "In"
                  values:
                    - "value"
