# Copyright (C) 2020 Dremio
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.


# Projectnessie GitHub Release workflow

# Manually triggered workflow, takes the "release-version" and "next-version" arguments.

# This workflow creates the git commits + git tag for a Nessie release.
# It requires a fully successful CI status of the commit going to be released, i.e. we rely on
# the "Main CI" workflow here.

# When this workflow pushes the release tag (e.g. `nessie-0.5.1`), the `release-publish.yml`
# workflow publishes the release artifacts

# Projectnessie really prefers a linear git history - aka no merges. PRs must not be merged
# while the release workflow runs. In case the git history would not be linear, this workflow will
# fail without having uploaded/pushed any release artifacts.

# No secrets (except the last step uses the GITHUB_TOKEN to push release-commits+tag to the branch)
# are needed for this workflow.

name: Create Release

on:
  # Manually triggered
  workflow_dispatch:
    inputs:
      releaseVersion:
        description: 'The version to release - e.g. `0.5.0`'
        required: true
      nextVersion:
        description: 'The nest development version - e.g. `0.6.0` - without the SNAPSHOT suffix'
        required: true
      ref:
        description: 'Optional: the Git reference to create the release from. Defaults to HEAD of the main branch.'
        required: false
        default: ''

jobs:
  build:
    name: Create release
    runs-on: ubuntu-latest
    if: ${{ github.repository == 'projectnessie/nessie' }}
    env:
      GIT_TAG: nessie-${{ github.event.inputs.releaseVersion }}
      RELEASE_VERSION: ${{ github.event.inputs.releaseVersion }}
      NEXT_VERSION: ${{ github.event.inputs.nextVersion }}

    steps:

    ### BEGIN runner setup
    - name: Update /etc/hosts
      run: echo -e "$(ip addr show eth0 | grep "inet\b" | awk '{print $2}' | cut -d/ -f1)\t$(hostname -f) $(hostname -s)" | sudo tee -a /etc/hosts
    - name: Checkout
      uses: actions/checkout@v2
      with:
        ref: ${{ github.events.inputs.ref }}
    - name: Set up JDK 11
      uses: actions/setup-java@v1
      with:
        java-version: 11
    # Using Python 3.8
    # Might be worth to bump the version and/or make it configurable in the future
    - name: Set up Python 3.8
      uses: actions/setup-python@v2
      with:
        python-version: 3.8
    - name: Cache local pip repository
      uses: actions/cache@v2
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    - name: Cache local Maven repository
      uses: actions/cache@v2
      with:
        path: |
          ~/.m2/repository
          !~/.m2/repository/org/projectnessie
        key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
        restore-keys: |
          ${{ runner.os }}-maven-
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install bumpversion
    ### END runner setup

    - name: Check commit status
      run: |
        gh api repos/${GITHUB_REPOSITORY}/commits/${GITHUB_SHA}/status --jq 'if (.state == "success") then "OK" else error("Commit status not OK") end'

    - name: Bump Maven release version ${{ github.event.inputs.releaseVersion }}
      run: |
        ./mvnw versions:set -DgenerateBackupPoms=false -DnewVersion=${RELEASE_VERSION}

    - name: Bump Python release version ${{ github.event.inputs.releaseVersion }}
      working-directory: ./python
      run: |
        bumpversion --no-commit --new-version ${RELEASE_VERSION} minor

    - name: Configure release-bot-user in git config
      run: |
        git config --global user.email "nessie-release-workflow-noreply@projectnessie.org"
        git config --global user.name "Projectnessie Release Workflow [bot]"

    # Record the release-version in git and add the git tag for the release.
    - name: Record ${{ github.event.inputs.releaseVersion }} release in git
      run: |
        git commit -a -m "[release] release nessie-${RELEASE_VERSION}"
        git tag ${GIT_TAG}

    # Update versions to next development iteration and add a new git commit
    - name: Set next development version version ${{ github.event.inputs.nextVersion }}
      run: |
        ./mvnw versions:set -DgenerateBackupPoms=false -DnewVersion=${NEXT_VERSION}-SNAPSHOT
        (cd python ; bumpversion --no-commit --new-version ${NEXT_VERSION} minor)

        git commit -a -m "[release] next development iteration ${NEXT_VERSION}-SNAPSHOT"

    # Push the 2 git commits and git tag. If this one fails, some other commit was pushed to the
    # 'main' branch and break the linear history for the Nessie git repo.
    # The `release-publish.yml` job will run when the release tag `nessie-x.y.z` has been pushed.
    - name: Push tag + branch
      run: |
        UPSTREAM="$(git remote)"
        REPO_OWNER="$(echo ${GITHUB_REPOSITORY} | cut -d/ -f2)"

        # Update the remote repo URL to include the secret so this job can push to the repo
        git remote set-url ${UPSTREAM} https://${REPO_OWNER}:${{ secrets.GITHUB_TOKEN }}@github.com/${GITHUB_REPOSITORY}

        git push ${UPSTREAM}
        git push ${UPSTREAM} :refs/tags/${GIT_TAG}
        git push ${UPSTREAM} ${GIT_TAG}
